@page "/login"
@layout EmptyLayout
@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject IApiClient ApiClient
@inject ILogger<Login> Logger

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">

    <MudPaper Class="pa-8" Elevation="3">
        <div class="d-flex justify-center mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="Color.Primary" Size="Size.Large" />
            <MudText Typo="Typo.h4" Class="ml-2">Conecta+</MudText>
        </div>
        <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-4">Portal do Cliente</MudText>

        <MudForm Model="@_loginModel">

            <MudTextField @bind-Value="_loginModel.Cpf"
                          For="@(() => _loginModel.Cpf)"
                          Label="CPF"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="O CPF é obrigatório!" />

            <MudTextField @bind-Value="_loginModel.Senha"
                          For="@(() => _loginModel.Senha)"
                          Label="Senha"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          RequiredError="A senha é obrigatória!"
                          Class="mt-4" />

            <div class="d-flex justify-end my-4">
                <MudLink Href="/esqueci-senha">Esqueceu a senha?</MudLink>
            </div>

            <MudAlert Severity="Severity.Error"
                      Class="mb-4"
                      Style="@(string.IsNullOrEmpty(_errorMessage) ? "display:none;" : "")">
                @_errorMessage
            </MudAlert>

            <MudButton OnClick="async () => await HandleLogin()"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       FullWidth="true"
                       Disabled="_isProcessing">
                @if (_isProcessing)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else
                {
                    @("Entrar")
                }
            </MudButton>
        </MudForm>
    </MudPaper>

    <MudText Align="Align.Center" Class="mt-4" Color="Color.Secondary">
    </MudText>

</MudContainer>

@code {
    private ClienteLoginRequestDto _loginModel = new ClienteLoginRequestDto();

    private bool _isProcessing = false;
    private string? _errorMessage = null;

    private async Task HandleLogin()
    {
        _isProcessing = true;
        _errorMessage = null;
        Logger.LogInformation("--- HandleLogin (OnClick) INICIADO ---");

        try
        {
            Logger.LogInformation("1. CPF: {Cpf}", _loginModel.Cpf);
            Logger.LogInformation("2. Chamando ApiClient.LoginAsync...");

            var loginResponse = await ApiClient.LoginAsync(_loginModel);

            Logger.LogInformation("3. Chamada à API finalizada.");

            if (loginResponse != null)
            {
                Logger.LogInformation("4. SUCESSO! Resposta recebida. Redirecionando...");
                NavigationManager.NavigateTo("/dash");
            }
            else
            {
                Logger.LogWarning("4. FALHA! API retornou nulo (CPF/Senha inválidos?).");
                _errorMessage = "CPF ou Senha inválidos. Tente novamente.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "5. EXCEÇÃO! Erro ao conectar com o servidor.");
            _errorMessage = "Erro ao conectar com o servidor. Tente novamente mais tarde.";
        }
        finally
        {
            _isProcessing = false;
            Logger.LogInformation("--- HandleLogin FINALIZADO ---");
            StateHasChanged();
        }
    }
}